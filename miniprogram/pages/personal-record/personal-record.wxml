<view class="container">
  <navigation-bar title="ä¸ªäººè®°è´¦" bind:back="onBack"></navigation-bar>

  <scroll-view class="content" scroll-y style="padding-top: {{navBarHeight}}px;">
    <!-- æ ‡ç­¾åˆ‡æ¢ -->
    <view class="tabs">
      <view class="tab-item {{activeTab === 'add' ? 'active' : ''}}" bindtap="onSwitchTab" data-tab="add">
        <text class="tab-label">è®°ä¸€ç¬”</text>
      </view>
      <view class="tab-item {{activeTab === 'list' ? 'active' : ''}}" bindtap="onSwitchTab" data-tab="list">
        <text class="tab-label">å†å²è®°å½•</text>
      </view>
    </view>

    <!-- è®°ä¸€ç¬” -->
    <view class="tab-content" wx:if="{{activeTab === 'add'}}">
      <view class="form-section">
        <!-- æ¸¸æˆç±»å‹ -->
        <view class="form-card">
          <text class="form-card-title">æ¸¸æˆç±»å‹</text>
          <view class="game-type-grid">
            <view
              class="type-chip {{gameType === item ? 'active' : ''}}"
              wx:for="{{gameTypes}}"
              wx:key="*this"
              bindtap="onSelectGameType"
              data-type="{{item}}"
            >
              <text>{{item}}</text>
            </view>
            <view
              class="type-chip {{isCustomType ? 'active' : ''}}"
              bindtap="onCustomType"
            >
              <text>è‡ªå®šä¹‰</text>
            </view>
          </view>
          <input
            wx:if="{{isCustomType}}"
            class="custom-type-input"
            placeholder="è¾“å…¥æ¸¸æˆç±»å‹"
            value="{{customGameType}}"
            bindinput="onCustomTypeInput"
          />
        </view>

        <!-- ç»“ç®—æ–¹å¼ -->
        <view class="form-card">
          <text class="form-card-title">ç»“ç®—æ–¹å¼</text>
          <view class="mode-switch">
            <view class="mode-item {{settlementMode === 'score' ? 'active' : ''}}" bindtap="onSelectMode" data-mode="score">
              <text>ç§¯åˆ†</text>
            </view>
            <view class="mode-item {{settlementMode === 'money' ? 'active' : ''}}" bindtap="onSelectMode" data-mode="money">
              <text>é‡‘é¢</text>
            </view>
          </view>
        </view>

        <!-- ç©å®¶åˆ—è¡¨ -->
        <view class="form-card">
          <view class="form-card-header">
            <text class="form-card-title">ç©å®¶</text>
            <view class="add-player-btn" bindtap="onAddPlayer">
              <text>+ æ·»åŠ </text>
            </view>
          </view>

          <view class="player-list">
            <view class="player-row" wx:for="{{players}}" wx:key="index">
              <view class="player-name-wrap">
                <input
                  class="player-name-input"
                  placeholder="ç©å®¶{{index + 1}}"
                  value="{{item.name}}"
                  data-index="{{index}}"
                  bindinput="onPlayerNameInput"
                />
              </view>
              <view class="player-score-wrap">
                <input
                  class="player-score-input"
                  type="digit"
                  placeholder="0"
                  value="{{item.finalScore || ''}}"
                  data-index="{{index}}"
                  bindinput="onPlayerScoreInput"
                />
              </view>
              <view class="remove-player-btn" wx:if="{{players.length > 2}}" bindtap="onRemovePlayer" data-index="{{index}}">
                <text>âœ•</text>
              </view>
            </view>
          </view>

          <!-- åˆè®¡ -->
          <view class="total-row">
            <text class="total-label">åˆè®¡</text>
            <text class="total-value {{totalScore === 0 ? 'balanced' : 'unbalanced'}}">
              {{totalScore >= 0 ? '+' : ''}}{{totalScore}}
            </text>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="form-card">
          <text class="form-card-title">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
          <input
            class="note-input"
            placeholder="ä»Šå¤©æ‰‹æ°”ä¸é”™..."
            value="{{note}}"
            bindinput="onNoteInput"
          />
        </view>

        <!-- æäº¤ -->
        <button class="submit-btn" bindtap="onSubmit" loading="{{submitting}}">
          ä¿å­˜è®°å½•
        </button>
      </view>
    </view>

    <!-- å†å²è®°å½• -->
    <view class="tab-content" wx:if="{{activeTab === 'list'}}">
      <loading-spinner wx:if="{{loading}}" loading="{{loading}}"></loading-spinner>

      <view wx:if="{{!loading && records.length > 0}}" class="records-list">
        <view class="record-item" wx:for="{{records}}" wx:key="_id">
          <view class="record-item-header">
            <view class="record-type-tag">{{item.gameType}}</view>
            <text class="record-date">{{item.playedAtText}}</text>
            <text class="record-mode">{{item.settlementMode === 'money' ? 'ğŸ’°' : 'ğŸ¯'}}</text>
          </view>
          <view class="record-players">
            <view class="record-player" wx:for="{{item.players}}" wx:for-item="player" wx:key="name">
              <text class="rp-name">{{player.name}}</text>
              <text class="rp-score {{player.finalScore >= 0 ? 'positive' : 'negative'}}">
                {{player.finalScore >= 0 ? '+' : ''}}{{player.finalScore}}
              </text>
            </view>
          </view>
          <text class="record-note" wx:if="{{item.note}}">{{item.note}}</text>
        </view>
      </view>

      <empty-state
        wx:if="{{!loading && records.length === 0}}"
        message="è¿˜æ²¡æœ‰è®°è´¦è®°å½•"
        icon="ğŸ“"
        buttonText="">
      </empty-state>
    </view>
  </scroll-view>
</view>
